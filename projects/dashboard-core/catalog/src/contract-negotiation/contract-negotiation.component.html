<!--
Copyright (c) 2025 Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V.

This program and the accompanying materials are made available under the
terms of the Apache License, Version 2.0 which is available at
https://www.apache.org/licenses/LICENSE-2.0

SPDX-License-Identifier: Apache-2.0

Contributors:
Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V. - initial API and implementation
-->

<form
  #negotiationForm="ngForm"
  (ngSubmit)="startNegotiation()"
  class="grid grid-cols-1 2xl:grid-cols-2 gap-4 gap-x-6 items-start overflow-y-auto h-full [&_label]:shrink-0"
>
  <h1 class="text-xl text-center divider m-0 2xl:col-span-2">Catalog Dataset</h1>
  <div class="flex flex-col [&_>*]:mb-4 [&_>*]:last:mb-0">
    <fieldset class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box">
      <legend class="fieldset-legend text-sm">Catalog Details</legend>
      <lib-json-object-table
        class="mx-auto"
        [object]="catalog"
        [excludeKeys]="[]"
        [deleteButton]="false"
      ></lib-json-object-table>
    </fieldset>
    <fieldset class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box">
      <legend class="fieldset-legend text-sm">Dataset</legend>
      <lib-json-object-table
        class="mx-auto"
        [object]="dataset"
        [excludeKeys]="[
          'http://www.w3.org/ns/dcat#distribution',
          'http://www.w3.org/ns/odrl/2/hasPolicy',
          'name',
          'id',
        ]"
        [deleteButton]="false"
      ></lib-json-object-table>
    </fieldset>
  </div>

  <div class="flex flex-col [&_>*]:mb-4 [&_>*]:last:mb-0 h-full">
    <fieldset
      class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box"
      [ngClass]="{ 'border border-warning/50': !offerId }"
    >
      <legend class="fieldset-legend text-sm">Select an Offer</legend>
      @for (key of offerKeys; let last = $last; track key) {
        <div class="group">
          <label class="flex items-center gap-3 rounded-lg transition-colors cursor-pointer hover:bg-base-200">
            <input
              type="radio"
              name="radioGroup"
              [id]="'offer-' + key"
              [value]="key"
              [(ngModel)]="offerId"
              class="radio radio-primary radio-xs peer"
              required
              (click)="showOfferDetails(key)"
            />
            <span class="flex-1 text-base-content peer-checked:font-medium">Offer {{ key }}</span>
          </label>
        </div>
        @if (!last) {
          <div class="border-t border-base-300 -mx-2"></div>
        }
      }
    </fieldset>

    <fieldset
      class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box h-full"
      [ngClass]="{ 'border-warning/50': !offerId }"
    >
      <legend class="fieldset-legend text-sm">Selected Offer</legend>
      @if (offerId) {
        <div class="mockup-code overflow-auto">
          @for (line of selectedOffer | async; let i = $index; track i) {
            <pre [attr.data-prefix]="i + 1"><code class="compact text-xs">{{ line }}</code></pre>
          }
        </div>
      } @else {
        <div class="text-center text-sm text-base-content mt-10 opacity-50">No offer has been selected</div>
      }
    </fieldset>
  </div>

  <div class="2xl:col-span-2 flex flex-col items-center">
    <div class="divider mt-0"></div>
    @if (errorMsg) {
      <lib-alert
        title="Error"
        [msg]="errorMsg"
        (closeEvent)="errorMsg = ''"
        type="error"
        class="max-w-lg 2xl:max-w-xl mb-4"
        [timeoutSeconds]="5"
      ></lib-alert>
    }
    <button type="submit" [disabled]="negotiationForm.invalid" class="btn btn-lg btn-primary w-lg 2xl:w-xl">
      <i class="material-symbols-rounded">handshake</i>
      Negotiate
    </button>
  </div>
</form>
