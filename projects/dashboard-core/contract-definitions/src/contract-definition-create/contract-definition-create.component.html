<!--
    Copyright (c) 2025 Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V.

    This program and the accompanying materials are made available under the
    terms of the Apache License, Version 2.0 which is available at
    https://www.apache.org/licenses/LICENSE-2.0

    SPDX-License-Identifier: Apache-2.0

    Contributors:
         Fraunhofer-Gesellschaft zur Förderung der angewandten Forschung e.V. - initial API and implementation
-->

<form
  [formGroup]="contractDefinitionForm"
  (ngSubmit)="contractDefinitionInput ? updateContractDefinition() : createContractDefinition()"
  class="flex flex-col overflow-y-auto h-full [&_label]:shrink-0"
>
  <h1 class="text-xl text-center divider m-0">Contract Definition</h1>

  <fieldset class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box mb-4">
    <legend class="fieldset-legend text-sm">Common Fields</legend>
    <legend class="fieldset-label">ID</legend>
    <label
      class="input input-bordered !border-[var(--input-color)] flex items-center w-full"
      [ngClass]="!contractDefinitionInput ? 'tooltip tooltip-info tooltip-top' : ''"
      [attr.data-tip]="!contractDefinitionInput ? 'If not set a random UUID will be generated' : ''"
    >
      <span class="material-symbols-rounded opacity-50">contract_edit</span>
      <input type="text" class="grow" placeholder="ID" formControlName="id" name="id" />
      @if (!contractDefinitionInput) {
        <span class="badge badge-info">Optional</span>
      }
    </label>
  </fieldset>
  @if ((policyDefinitions$ | async)?.length ?? 0 > 0) {
    <fieldset class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box mb-4">
      <legend class="fieldset-legend text-sm">Policy Selections</legend>
      <legend class="fieldset-label">Access Policy</legend>
      <label
        class="select w-full"
        [ngClass]="contractDefinitionForm.get('accessPolicyId')?.invalid ? 'select-error' : ''"
      >
        <span class="material-symbols-rounded opacity-50">policy</span>
        <select formControlName="accessPolicyId" name="accessPolicyId" required>
          @for (policy of policyDefinitions$ | async; track policy) {
            <option [ngValue]="policy.id">{{ policy.id }}</option>
          }
        </select>
      </label>
      @if (contractDefinitionForm.get('accessPolicyId')?.invalid) {
        <p class="fieldset-label text-error">Mandatory</p>
      }

      <legend class="fieldset-label">Contract Policy</legend>
      <label
        class="select w-full"
        [ngClass]="contractDefinitionForm.get('contractPolicyId')?.invalid ? 'select-error' : ''"
      >
        <span class="material-symbols-rounded opacity-50">policy</span>
        <select formControlName="contractPolicyId" name="contractPolicyId" required>
          @for (policy of policyDefinitions$ | async; track policy) {
            <option [ngValue]="policy.id">{{ policy.id }}</option>
          }
        </select>
      </label>
      @if (contractDefinitionForm.get('contractPolicyId')?.invalid) {
        <p class="fieldset-label text-error">Mandatory</p>
      }
    </fieldset>
  } @else {
    <div class="skeleton flex justify-center items-center h-56 rounded-2xl mb-3 mt-1">
      <div
        class="tooltip tooltip-open tooltip-primary"
        data-tip="No policies yet! Create a policy first before adding a contract definition."
      >
        <button type="button" class="btn btn-primary btn-dash" (click)="createPolicy()">
          <span class="material-symbols-rounded">policy</span>
          Policy View
        </button>
      </div>
    </div>
  }

  <fieldset class="fieldset w-lg bg-base-200 border border-base-300 p-4 rounded-box">
    <legend class="fieldset-legend text-sm">Asset Selection</legend>
    @if (assetIds$ | async; as assetIds) {
      <lib-multiselect-with-search
        #assetsSelector
        [items]="assetIds"
        [preSelectedItems]="assetInput"
        (selectedItemsChange)="handleSelectionChange($event)"
        class="w-full"
      ></lib-multiselect-with-search>
    }
    @if (assetInput.length > 0) {
      <div class="pt-3"></div>
    }
    @for (asset of assetInput; track asset) {
      <div class="flex items-center ml-4">
        <span class="material-symbols-rounded mr-2">check</span>
        <span class="truncate">ID = {{ asset }}</span>
      </div>
    }
  </fieldset>

  <div class="divider"></div>
  @if (errorMsg) {
    <lib-alert title="Error" [msg]="errorMsg" (closeEvent)="errorMsg = ''" type="error" class="w-lg mb-4"></lib-alert>
  }
  <button
    type="submit"
    [disabled]="contractDefinitionForm.invalid"
    class="btn btn-lg w-lg"
    [ngClass]="contractDefinitionInput ? 'btn-warning' : 'btn-primary'"
  >
    <i class="material-symbols-rounded">{{ contractDefinitionInput ? 'update' : 'add' }}</i>
    {{ contractDefinitionInput ? 'Update' : 'Create' }} Contract Definition
  </button>
</form>
